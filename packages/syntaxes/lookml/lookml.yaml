scopeName: source.lookml

patterns:
  - include: "#comments"
  - include: "#model"
  - include: "#explore"
  - include: "#view"
  - include: "#test"
  - include: "#string"
  - include: "#invalid_curl"

repository:
  # ==============================================
  # Model specific parameter blocks
  # ==============================================
  model:
    patterns:
      # string options
      - match: \b(label|connection|include|persist_for)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # numeric options
      - match: \b(fiscal_month_offset)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_numeric.lookml
          2:
            patterns:
              - include: "#numeric"

      # identifier without dot
      - match: \b(persist_with)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # yesno
      - match: \b(case_sensitive)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # week start day
      - match: \b(week_start_day)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.week_start_day.lookml
          2:
            patterns:
              - name: support.constant.day.lookml
                match: \b(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b
              - name: invalid.illegal.day.lookml
                match: \w+

      # model specific blocks
      - include: "#named_value_format"
      - include: "#map_layer"
      - include: "#datagroup"
      - include: "#access_grant"

  # ------------------------------
  # Model: named value format
  # ------------------------------
  named_value_format:
    begin: \b(named_value_format)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.named_value_format.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string options
      - match: \b(value_format)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # yesno options
      - match: \b(strict_value_format)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Model: map layer
  # ------------------------------
  map_layer:
    begin: \b(map_layer)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.map_layer.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string option
      - match: \b(extents_json_url|feature_key|file|label|property_key|property_label_key|url)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # numeric option
      - match: \b((max|min)_zoom_level)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_numeric.lookml
          3:
            patterns:
              - include: "#numeric"

      # identifier without dot
      - match: \b(projection)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # format
      - match: \b(format)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.format.lookml
          2:
            patterns:
              - name: support.constant.day.lookml
                match: \b(topojson|vector_tile_region)\b
              - name: invalid.illegal.day.lookml
                match: \w+

      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Model: data group
  # ------------------------------
  datagroup:
    begin: \b(datagroup)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.datagroup.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string
      - match: \b(label|description|max_cache_age)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # sql
      - begin: \b(?=sql_trigger\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Model: access grant
  # ------------------------------
  access_grant:
    begin: \b(access_grant)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.access_grant.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # identifier without dot
      - match: \b(user_attribute)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # string array
      - begin: \b(allowed_values)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      - include: "#invalid_curl"


  # ==============================================
  # explore specific parameter blocks
  # ==============================================
  explore:
    begin: \b(explore)\s*:\s*\+?([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.explore.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string
      - match: \b(description|group_label|view_label|label|persist_for)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # string array
      - begin: \b(tags)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.tags.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # yesno
      - match: \b(hidden|case_sensitive|symmetric_aggregates)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # identifier without dot
      - match: \b(from|persist_with|view_name)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # identifier array without dot
      - begin: \b(?=cancel_grouping_fields\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_array"

      # identifier array with dot
      - begin: \b(?=extends|always_join|required_access_grants\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # sql
      - begin: \b(?=sql_(always_where|always_having|table_name)\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # explore specific blocks
      - include: "#fields_explore"
      - include: "#access_filter"
      - include: "#always_filter"
      - include: "#conditionally_filter"
      - include: "#join"
      - include: "#aggregate_table"
      - include: "#query_explore"

      # common blocks
      - include: "#extension"
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Explore: fields
  # ------------------------------
  fields_explore:
    begin: \b(fields)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.fields.lookml
    end: \]
    patterns:
      - include: "#comments"
      - include: "#fields_allow_minus"
      # all field
      - match: (\B-|\b)[A-Za_z0-9_]+\.[A-Za_z0-9_]+(\*\B|\b)
      - match: (\B-|\b)(ALL_FIELDS)(\*\B|\b)
        captures:
          2:
            name: support.constant.all_fields.lookml


  # ------------------------------
  # Explore: access filter
  # ------------------------------
  access_filter:
    begin: \b(access_filter)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.test.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # identifier without dot
      - match: \b(user_attribute)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # common blocks
      - include: "#field"
      - include: "#invalid_curl"


  # ------------------------------
  # Explore: always filter
  # ------------------------------
  always_filter:
    begin: \b(always_filter)\s*:\s*\{
    beginCaptures:
      1:
        name: keyword.control.always_filter.lookml
    end: \}
    patterns:
      - include: "#comments"

      # common blocks
      - include: "#filters"
      - include: "#invalid_curl"

  # ------------------------------
  # Explore: conditionally filter
  # ------------------------------
  conditionally_filter:
    begin: \b(conditionally_filter)\s*:\s*\{
    beginCaptures:
      1:
        name: keyword.control.conditionally_filter.lookml
    end: \}
    patterns:
      - include: "#comments"

      # identifier array with dot
      - begin: \b(?=unless\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_array"

      # common blocks
      - include: "#filters"
      - include: "#invalid_curl"

  # ------------------------------
  # Explore: join
  # ------------------------------
  join:
    begin: \b(join)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.join.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string
      - match: \b(view_label)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # yesno
      - match: \b(outer_only)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # identifier without dot
      - match: \b(from|foreign_key)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # identifier array without dot
      - begin: \b(?=(required_joins|required_access_grants)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # sql
      - begin: \b(?=(sql_(on|where|table_name|foreign_key)|sql)\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # join specific blocks
      - include: "#fields_join"
      - include: "#type_join"
      - include: "#relationship"

      # common blocks
      - include: "#string"
      - include: "#invalid_curl"

  fields_join:
    begin: \b(fields)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.option_ident_no_dot_array.lookml
    end: \]
    patterns:
      - include: "#comments"
      - include: "#fields_allow_star"

  type_join:
    match: \b(type)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.join_type.lookml
      2:
        patterns:
          - name: support.constant.join_type.lookml
            match: \b(inner|(left|full)_outer|cross)\b
          - name: invalid.illegal.join_type.lookml
            match: \w+

  relationship:
    match: \b(relationship)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.relationship.lookml
      2:
        patterns:
          - name: support.constant.relationship.lookml
            match: \b((one|many)_to_(one|many))\b
          - name: invalid.illegal.relationship.lookml
            match: \w+

  # ------------------------------
  # Explore: aggregation awareness
  # ------------------------------
  aggregate_table:
    begin: \b(aggregate_table)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.aggregate_table.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # aggregate table specific blocks
      - include: "#aggregate_table_query"
      - include: "#materialization"

      # common blocks
      - include: "#invalid_curl"

  aggregate_table_query:
    begin: \b(query)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.query.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # identifier array
      - begin: \b(?=(dimensions|measures)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_array"

      # common blocks
      - include: "#filters"
      - include: "#timezone"
      - include: "#sorts"
      - include: "#string"
      - include: "#invalid_curl"

  materialization:
    begin: \b(materialization)\s*:\s*\{
    beginCaptures:
      1:
        name: keyword.control.materialization.lookml
    end: \}
    patterns:
      - include: "#comments"

      # string
      - match: \b(persist_for|distribution)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # string array
      - begin: \b(cluster_keys|indexes|partition_keys|sortkeys|increment_key)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # numeric
      - match: \b(increment_offset)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_numeric.lookml
          2:
            patterns:
              - include: "#numeric"

      # sql
      - begin: \b(?=sql_trigger_value\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # common blocks
      - include: "#distribution_style"
      - include: "#datagroup_trigger"
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Explore: query (quick start)
  # ------------------------------
  query_explore:
    begin: \b(query)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.query.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string
      - match: \b(label|description)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # numeric
      - match: \b(limit)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_numeric.lookml
          2:
            patterns:
              - include: "#numeric"

      # identifier array without dot
      - begin: \b(?=(dimensions|measures|pivots)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_array"

      # common blocks
      - include: "#filters"
      - include: "#sorts"
      - include: "#string"
      - include: "#invalid_curl"


  # ==============================================
  # View specific parameter blocks
  # ==============================================
  view:
    begin: \b(view)\s*:\s*\+?([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.view.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string
      - match: \b(label)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # identifier array without dot
      - begin: \b(?=(extends|required_access_grants)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # yesno
      - match: \b(fields_hidden_by_default|suggestions|final)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # sql
      - begin: \b(?=sql_table_name\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # view specific blocks
      - include: "#derived_table"
      - include: "#set"

      # dimension, measure, ... etc
      - include: "#field_def"

      # common blocks
      - include: "#extension"
      - include: "#drill_fields"
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # View: derived table
  # ------------------------------
  derived_table:
    begin: \b(derived_table)\s*:\s*\{
    beginCaptures:
      1:
        name: keyword.control.derived_table.lookml
    end: \}
    patterns:
      - include: "#comments"

      # string
      - match: \b(persist_for|distribution|interval_trigger|increment_key)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_string.lookml
          2:
            name: invalid.illegal.string.lookml

      # string array
      - begin: \b(cluster_keys|indexes|partition_keys|sortkeys)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # numeric
      - match: \b(increment_offset)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_numeric.lookml
          2:
            patterns:
              - include: "#numeric"

      # yesno
      - match: \b(materialized_view|publish_as_db_view)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # sql
      - begin: \b(?=sql(_trigger_value|_create)?\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # explore specific blocks
      - include: "#explore_source_derived_table"
      - include: "#table_compression"
      - include: "#table_format"
      - include: "#create_process"

      # common blocks
      - include: "#datagroup_trigger"
      - include: "#distribution_style"
      - include: "#string"
      - include: "#invalid_curl"

  create_process:
    begin: \b(create_process)\s*:\s*\{
    beginCaptures:
      1:
        name: keyword.control.create_process.lookml
    end: \}
    patterns:
      - include: "#comments"
      - patterns:
          - begin: \b(?=sql_step\s*:\s*)
            end: ;;
            patterns:
              - include: "#sql_block"
      - include: "#invalid_curl"

  table_compression:
    match: \b(table_compression)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.table_compression.lookml
      2:
        patterns:
          - name: support.constant.table_compression.lookml
            match: \b(GZIP|SNAPPY)\b
          - name: invalid.illegal.table_compression.lookml
            match: "[^\\s]+"

  table_format:
    match: \b(table_format)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.table_format.lookml
      2:
        patterns:
          - name: support.constant.table_format.lookml
            match: \b(PARQUET|ORC|AVRO|JSON|TEXTFILE)\b
          - name: invalid.illegal.table_format.lookml
            match: "[^\\s]+"

  # ------------------------------
  # View: explore source
  # ------------------------------
  explore_source_derived_table:
    begin: \b(explore_source)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.explore_source.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # explore source (for view) specific blocks
      - include: "#derived_column"
      - include: "#bind_filters"
      - include: "#bind_all_filters"

      # common blocks
      - include: "#column"
      - include: "#filters"
      - include: "#expression_custom_filter"
      - include: "#sorts"
      - include: "#limit"
      - include: "#timezone"
      - include: "#string"
      - include: "#invalid_curl"

  derived_column:
    begin: \b(derived_column)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.derived_column.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"
      - begin: \b(?=sql\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"
      - include: "#invalid_curl"

  bind_filters:
    begin: \b(bind_filters)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.bind_filters.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"
      - patterns:
          - match: \b((from|to)_field)\s*:\s*([A-Za-z0-9_$@*.-]*)
            captures:
              1:
                name: keyword.control.option_ident.lookml
              3:
                patterns:
                  - include: "#ident"
      - include: "#invalid_curl"

  bind_all_filters:
    match: \b(bind_all_filters)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.option_yesno.lookml
      2:
        patterns:
          - include: "#yesno"

  # ------------------------------
  # View: set
  # ------------------------------
  set:
    begin: \b(set)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.set.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"
      - begin: \b(fields)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_ident_no_dot_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#fields_allow_star"
      - include: "#invalid_curl"


  # ==============================================
  # fields parameter
  # ==============================================
  field_def:
    patterns:
      - include: "#dimension"
      - include: "#dimension_group"
      - include: "#measure"
      - include: "#filter"
      - include: "#parameter"

  # ------------------------------
  # Field: dimension
  # ------------------------------
  dimension:
    begin: \b(dimension)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.dimension.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string option
      - match: \b(view_label|label|description|group(?:_item)?_label|suggest_persist_for|value_format|fanout_on)\s*:\s*
        captures:
          1:
            name: keyword.control.option_string.lookml

      # string array
      - begin: \b(tags|suggestions)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # identifier without dot
      - match: \b(suggest_explore|value_format_name|map_layer_name)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # identifier with dot
      - match: \b(suggest_dimension|label_from_parameter|(?:start|end)_location_field)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident"

      # identifier array (without dot)
      - begin: \b(?=(alias|required_access_grants)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # identifier array (with dot)
      - begin: \b(?=(required_fields)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_array"

      # numeric array
      - begin: \b(tiers)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_numeric_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#numeric"

      # sql
      - begin: \b(?=sql|sql_(?:latitude|longitude|start|end)\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # html
      - begin: \b(?=html\s*:\s*)
        end: ;;
        patterns:
          - include: "#html_block"

      # yesno
      - match: \b(hidden|can_filter|alpha_sort|case_sensitive|skip_drill_filter|bypass_suggest_restrictions|full_suggestions|convert_tz|suggestable|allow_fill|primary_key)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # type
      - match: \b(type)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - name: support.constant.type.dimension.lookml
                match: \b(bin|distance|location|number|string|tier|yesno|zipcode|int)\b
              - include: "#time_type"
              - include: "#duration_type"
              - name: invalid.illegal.type.dimension.lookml
                match: "[A-Za-z0-9_$@*.-]+"

      # string data type
      - match: \b(string_datatype)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - name: support.constant.string_datatype.dimension.lookml
                match: \b(unicode)\b
              - name: invalid.illegal.string_datatype.dimension.lookml
                match: "[A-Za-z0-9_$@*.-]+"

      # dimension specific
      - include: "#case"
      - include: "#tier_style"
      - include: "#units"

      # common blocks for field definition
      - include: "#datatype"
      - include: "#order_by_field"
      - include: "#link"
      - include: "#action"

      # common blocks
      - include: "#drill_fields"
      - include: "#string"
      - include: "#invalid_curl"

  case:
    patterns:
      - begin: \b(case)\s*:\s*\{
        beginCaptures:
          1:
            name: keyword.control.case.lookml
        end: \}
        patterns:
          - include: "#comments"
          - begin: \b(when)\s*:\s*\{
            beginCaptures:
              1:
                name: keyword.control.when.lookml
            end: \}
            patterns:
              - include: "#comments"
              - match: \b(label)\s*:\s*
                captures:
                  1:
                    name: keyword.control.option_string.lookml
              - begin: \b(?=sql\s*:\s*)
                end: ;;
                patterns:
                  - include: "#sql_block"
              - include: "#string"
              - include: "#invalid_curl"
          - include: "#invalid_curl"

  tier_style:
    match: \b(style)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.tier_style.lookml
      2:
        patterns:
          - name: support.constant.tier_style.lookml
            match: \b(classic|interval|integer|relational)\b
          - name: invalid.illegal.tier_style.lookml
            match: \w+

  units:
    match: \b(units)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.units.lookml
      2:
        patterns:
          - name: support.constant.units.lookml
            match: \b(feet|kilometers|meters|miles|nautical_miles|yards)\b
          - name: invalid.illegal.units.lookml
            match: "[^\\s]+"

  # ------------------------------
  # Field: dimension group
  # ------------------------------
  dimension_group:
    begin: \b(dimension_group)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.dimension_group.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string option
      - match: \b(view_label|label|description|group(?:_item)?_label|fanout_on)\s*:\s*
        captures:
          1:
            name: keyword.control.option_string.lookml

      # string array
      - begin: \b(tags)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # identifier without dot
      - match: \b(suggest_explore)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # identifier with dot
      - match: \b(suggest_dimension)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident"

      # identifier array (without dot)
      - begin: \b(?=(alias|required_access_grants)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # sql
      - begin: \b(?=sql|sql_(?:start|end)\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # html
      - begin: \b(?=html\s*:\s*)
        end: ;;
        patterns:
          - include: "#html_block"

      # yesno
      - match: \b(hidden|can_filter|bypass_suggest_restrictions|full_suggestions|convert_tz|suggestable|allow_fill)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # type
      - match: \b(type)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - name: support.constant.type.dimension.lookml
                match: \b(time|duration)\b
              - name: invalid.illegal.type.dimension.lookml
                match: "[A-Za-z0-9_$@*.-]+"

      # common blocks for fields
      - include: "#order_by_field"

      # dimension group specific blocks
      - include: "#timeframes"
      - include: "#intervals"

      # common blocks for field definition
      - include: "#datatype"

      # common blocks
      - include: "#drill_fields"
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Field: measure
  # ------------------------------
  measure:
    begin: \b(measure)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.measure.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string option
      - match: \b(view_label|label|description|group(?:_item)?_label|value_format|fanout_on)\s*:\s*
        captures:
          1:
            name: keyword.control.option_string.lookml

      # string array
      - begin: \b(tags)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # identifier without dot
      - match: \b(suggest_explore|value_format_name)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # identifier with dot
      - match: \b(suggest_dimension|label_from_parameter|list_field)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident"

      # identifier array (without dot)
      - begin: \b(?=(alias|required_access_grants)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # identifier array (with dot)
      - begin: \b(?=(required_fields)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_array"

      # numeric
      - match: \b(approximate_threshold|precision|percentile)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_numeric.lookml
          2:
            patterns:
              - include: "#numeric"

      # yesno
      - match: \b(hidden|can_filter|approximate|allow_approximate_optimization|convert_tz|suggestable)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # sql
      - begin: \b(?=sql|sql_distinct_key\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # html
      - begin: \b(?=html\s*:\s*)
        end: ;;
        patterns:
          - include: "#html_block"

      # direction
      - match: \b(direction)\s*:\s*(\"[^"]*\")?
        captures:
          1:
            name: keyword.control.direction.lookml
          2:
            patterns:
              - name: string.quoted.double.lookml
                match: \"(row|column)\"
              - name: invalid.illegal.direction.lookml
                match: "[^\"]+"

      # type
      - match: \b(type)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - name: support.constant.type.measure.lookml
                match: \b((:?(:?average|count|median|percentile|sum)(:?_distinct)?)|percent_of_(:?previous|total)|running_total|date|list|max|min|number|string|yesno|int)\b
              - name: invalid.illegal.type.measure.lookml
                match: "[A-Za-z0-9_$@*.-]+"

      # common blocks for field definition
      - include: "#datatype"
      - include: "#link"
      - include: "#action"
      - include: "#order_by_field"

      # common blocks
      - include: "#filters"
      - include: "#drill_fields"
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Field: filter
  # ------------------------------
  filter:
    begin: \b(filter)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.filter.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string option
      - match: \b(view_label|label|description|group(?:_item)?_label|suggest_persist_for|default_value)\s*:\s*
        captures:
          1:
            name: keyword.control.option_string.lookml

      # string array
      - begin: \b(tags|suggestions)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # identifier without dot
      - match: \b(suggest_explore)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # identifier with dot
      - match: \b(suggest_dimension)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident"

      # identifier array (without dot)
      - begin: \b(?=(alias|required_access_grants)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # sql
      - begin: \b(?=sql\s*:\s*)
        end: ;;
        patterns:
          - include: "#sql_block"

      # yesno
      - match: \b(hidden|case_sensitive|bypass_suggest_restrictions|full_suggestions|convert_tz|suggestable)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # type
      - match: \b(type)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - name: support.constant.type.dimension.lookml
                match: \b(number|string|yesno)\b
              - include: "#time_type"
              - name: invalid.illegal.type.dimension.lookml
                match: "[A-Za-z0-9_$@*.-]+"

      # common blocks for field definition
      - include: "#datatype"

      # common blocks
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Field: parameter
  # ------------------------------
  parameter:
    begin: \b(parameter)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.parameter.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      # string option
      - match: \b(view_label|label|description|suggest_persist_for|default_value)\s*:\s*
        captures:
          1:
            name: keyword.control.option_string.lookml

      # string array
      - begin: \b(tags|suggestions)\s*:\s*\[
        beginCaptures:
          1:
            name: keyword.control.option_string_array.lookml
        end: \]
        patterns:
          - include: "#comments"
          - include: "#string"

      # identifier without dot
      - match: \b(suggest_explore)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident_no_dot"

      # identifier with dot
      - match: \b(suggest_dimension)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident"

      # identifier array (without dot)
      - begin: \b(?=(alias|required_access_grants)\s*:\s*\[)
        end: \]
        patterns:
          - include: "#option_ident_no_dot_array"

      # yesno
      - match: \b(hidden|bypass_suggest_restrictions|full_suggestions|convert_tz|suggestable)\s*:\s*(\w*)
        captures:
          1:
            name: keyword.control.option_yesno.lookml
          2:
            patterns:
              - include: "#yesno"

      # type
      - match: \b(type)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - name: support.constant.type.dimension.lookml
                match: \b(date(?:_time)?|number|string|unquoted|yesno)\b
              - name: invalid.illegal.type.dimension.lookml
                match: "[A-Za-z0-9_$@*.-]+"

      # parameter specific block
      - include: "#allowed_value"

      # common blocks
      - include: "#string"
      - include: "#invalid_curl"

  allowed_value:
    begin: \b(allowed_value)\s*:\s*\{
    beginCaptures:
      1:
        name: keyword.control.allowed_value.lookml
    end: \}
    patterns:
      - include: "#comments"
      - match: \b(label|value)\s*:\s*
        captures:
          1:
            name: keyword.control.option_string.lookml
      - include: "#string"
      - include: "#invalid_curl"


  # ------------------------------
  # Filed (common): timeframe & time
  # ------------------------------
  timeframes:
    begin: \b(timeframes)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.option_ident_array.lookml
    end: \]
    patterns:
      - include: "#comments"
      # special
      - name: support.constant.timeframe.lookml
        match: \b(raw|yesno)\b
      # year
      - name: support.constant.timeframe.lookml
        match: \b((fiscal_)?year|(day|week)_of_year)\b
      # quarter
      - name: support.constant.timeframe.lookml
        match: \b((fiscal_)?quarter(_of_year)?)\b
      # month
      - name: support.constant.timeframe.lookml
        match: \b(month|(fiscal_)?month_num|month_name|day_of_month)\b
      # week, date
      - name: support.constant.timeframe.lookml
        match: \b(week|day_of_week(_index)?|date)\b
      # time
      - name: support.constant.timeframe.lookml
        match: \b(time(_of_day)?)\b
      # hour
      - name: support.constant.timeframe.lookml
        match: \b(hour(_of_day|2|3|4|6|8|12)?)\b
      # minute
      - name: support.constant.timeframe.lookml
        match: \b(minute(2|3|4|5|6|10|12|15|20|30)?)\b
      # second
      - name: support.constant.timeframe.lookml
        match: \b((milli|micro)?second)\b
      - name: support.constant.timeframe.lookml
        match: \b(millisecond(2|4|5|8|10|20|25|40|50|100|125|200|250|500))\b
      # invalid
      - name: invalid.illegal.timeframe.lookml
        match: "[A-Za-z0-9_$@*.-]+"
      - include: "#invalid_curl"

  time_type:
    patterns:
      # special type
      - name: support.constant.timeframe.lookml
        match: \bdate_(raw)\b
      # year
      - name: support.constant.timeframe.lookml
        match: \bdate_((fiscal_)?year|(day|week)_of_year)\b
      # quarter
      - name: support.constant.timeframe.lookml
        match: \bdate_((fiscal_)?quarter(_of_year)?)\b
      # month
      - name: support.constant.timeframe.lookml
        match: \bdate_(month|(fiscal_)?month_num|month_name|day_of_month)\b
      # week, date
      - name: support.constant.timeframe.lookml
        match: \bdate\b
      - name: support.constant.timeframe.lookml
        match: \bdate_(week|day_of_week(_index)?|date)\b
      # time
      - name: support.constant.timeframe.lookml
        match: \bdate_(time(_of_day)?)\b
      # hour
      - name: support.constant.timeframe.lookml
        match: \bdate_(hour(_of_day|2|3|4|6|8|12)?)\b
      # minute
      - name: support.constant.timeframe.lookml
        match: \bdate_(minute(2|3|4|5|6|10|12|15|20|30)?)\b
      # second
      - name: support.constant.timeframe.lookml
        match: \bdate_((milli|micro)?second)\b
      - name: support.constant.timeframe.lookml
        match: \bdate_(millisecond(2|4|5|8|10|20|25|40|50|100|125|200|250|500))\b

  # ------------------------------
  # Filed (common): interval & duration
  # ------------------------------
  intervals:
    begin: \b(intervals)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.option_ident_array.lookml
    end: \]
    patterns:
      - include: "#comments"
      - match: \b(day|hour|minute|month|quarter|second|week|year)\b
        captures:
          1:
            name: support.constant.interval.lookml
      # invalid
      - name: invalid.illegal.timeframe.lookml
        match: "[A-Za-z0-9_$@*.-]+"
      - include: "#invalid_curl"

  duration_type:
    name: support.constant.duration.lookml
    match: \bduration_(day|hour|minute|month|quarter|second|week|year)\b

  # ------------------------------
  # Filed (common): data type
  # ------------------------------
  datatype:
    match: \b(datatype)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.datatype.lookml
      2:
        patterns:
          - name: support.constant.datatype.lookml
            match: \b(epoch|timestamp|datetime|date|yyyymmdd)\b
          - name: invalid.illegal.datatype.lookml
            match: "[^\\s]+"

  # ------------------------------
  # Filed (common): action
  # ------------------------------
  action:
    patterns:
      - begin: \b(action)\s*:\s*\{
        beginCaptures:
          1:
            name: keyword.control.action.lookml
        end: \}
        patterns:
          - include: "#comments"
          # string option
          - match: \b(label|(:?(:?icon|form)_)?url)\s*:\s*
            captures:
              1:
                name: keyword.control.option_string.lookml
          # param
          - begin: \b(param)\s*:\s*\{
            beginCaptures:
              1:
                name: keyword.control.param.lookml
            end: \}
            patterns:
              - include: "#comments"
              # string option
              - match: \b(name|value)\s*:\s*
                captures:
                  1:
                    name: keyword.control.option_string.lookml
              - include: "#string"
              - include: "#invalid_curl"
          # form_param
          - begin: \b(form_param)\s*:\s*\{
            beginCaptures:
              1:
                name: keyword.control.form_param.lookml
            end: \}
            patterns:
              - include: "#comments"
              # string option
              - match: \b(label|name|default)\s*:\s*
                captures:
                  1:
                    name: keyword.control.option_string.lookml
              # yesno
              - match: \b(required)\s*:\s*(\w*)
                captures:
                  1:
                    name: keyword.control.option_yesno.lookml
                  2:
                    patterns:
                      - include: "#yesno"
              # option
              - begin: \b(option)\s*:\s*\{
                beginCaptures:
                  1:
                    name: keyword.control.option.lookml
                end: \}
                patterns:
                  - include: "#comments"
                  # string option
                  - match: \b(name|value)\s*:\s*
                    captures:
                      1:
                        name: keyword.control.option_string.lookml
                  - include: "#string"
                  - include: "#invalid_curl"
              # type
              - match: \b(type)\s*:\s*([A-Za-z0-9_$@*.-]*)
                captures:
                  1:
                    name: keyword.control.option_ident.lookml
                  2:
                    patterns:
                      - name: support.constant.type.action.lookml
                        match: \b(select|string|textarea)\b
                      - name: invalid.illegal.type.action.lookml
                        match: "[A-Za-z0-9_$@*.-]+"
              - include: "#string"
              - include: "#invalid_curl"
          - include: "#string"
          - include: "#invalid_curl"

  # ------------------------------
  # Filed (common): link
  # ------------------------------
  link:
    begin: \b(link)\s*:\s*\{
    beginCaptures:
      1:
        name: keyword.control.link.lookml
    end: \}
    patterns:
      - include: "#comments"
      - match: \b(url|label|icon_url)\s*:\s*
        captures:
          1:
            name: keyword.control.option_string.lookml
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # Filed (common): order by field
  # ------------------------------
  order_by_field:
    patterns:
      - match: \b(order_by_field)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident"


  # ==============================================
  # test specific parameter blocks
  # ==============================================
  test:
    begin: \b(test)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.test.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"
      - include: "#explore_source_test"
      - include: "#assert"
      - include: "#invalid_curl"

  # ------------------------------
  # explore source
  # ------------------------------
  explore_source_test:
    begin: \b(explore_source)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.explore_source.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"

      - include: "#column"
      - include: "#filters"
      - include: "#expression_custom_filter"
      - include: "#sorts"
      - include: "#limit"
      - include: "#timezone"
      - include: "#string"
      - include: "#invalid_curl"

  # ------------------------------
  # assert
  # ------------------------------
  assert:
    begin: \b(assert)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.assert.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"
      - include: "#expression"
      - include: "#invalid_curl"

  expression:
    begin: \b(expression)\s*:\s*
    beginCaptures:
      0:
        name: keyword.control.expression.lookml
    end: ;;
    endCaptures:
      0:
        name: punctuation.terminator.semi_semi.lookml
    patterns:
      - include: "#constant_ref"
      - include: "#dollar_field_ref"


  # ==============================================
  # common blocks
  # ==============================================
  # ------------------------------
  # filed definition
  # ------------------------------
  field:
    patterns:
      - match: \b(field)\s*:\s*([A-Za-z0-9_$@*.-]*)
        captures:
          1:
            name: keyword.control.option_ident.lookml
          2:
            patterns:
              - include: "#ident"

  fields_allow_star:
    patterns:
      # object references
      - name: invalid.illegal.ident1.lookml
        match: "[$@]\\{[A-Za-z0-9_$@*.-]*\\}"
      # invalid  star
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*\\*[A-Za-z0-9_$@*.-]+"
      # invalid character
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*[$@-][A-Za-z0-9_$@*.-]*"
      # two or more dots
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*(\\.[A-Za-z0-9_$@*.-]*){2,}"

  fields_allow_minus:
    patterns:
      # object references
      - name: invalid.illegal.ident1.lookml
        match: "[$@]\\{[A-Za-z0-9_$@*.-]*\\}"
      # invalid minus / star
      - name: invalid.illegal.ident2.lookml
        match: "[A-Za-z0-9_$@*.-]+-[A-Za-z0-9_$@*.-]*"
      - name: invalid.illegal.ident3.lookml
        match: "[A-Za-z0-9_$@*.-]*\\*[A-Za-z0-9_$@*.-]+"
      # invalid character
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*[$@][A-Za-z0-9_$@*.-]*"
      # two or more dots
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*(\\.[A-Za-z0-9_$@*.-]*){2,}"

  # ------------------------------
  # query definition
  # ------------------------------
  column:
    begin: \b(column)\s*:\s*([A-Za-z0-9_$@*.-]*)\s*\{
    beginCaptures:
      1:
        name: keyword.control.column.lookml
      2:
        patterns:
          - include: "#ident_no_dot"
    end: \}
    patterns:
      - include: "#comments"
      - include: "#field"
      - include: "#invalid_curl"

  sorts:
    begin: \b(sorts)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.sorts.lookml
    end: \]
    patterns:
      - include: "#comments"
      - match: :\s*\b(asc|desc)\b
        captures:
          1:
            name: support.constant.sort.lookml
      - include: "#ident"

  filters:
    begin: \b(filters)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.filters.lookml
    end: \]
    patterns:
      - include: "#comments"
      - include: "#ident"
      - include: "#string"
      - include: "#invalid_curl"

  expression_custom_filter:
    begin: \b(?=expression_custom_filter\s*:\s*)
    end: ;;
    patterns:
      - include: "#sql_block"

  limit:
    match: \b(limit)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.option_numeric.lookml
      2:
        patterns:
          - include: "#numeric"

  timezone:
    match: \b(timezone)\s*:\s*
    captures:
      1:
        name: keyword.control.option_string.lookml

  # ------------------------------
  # object references
  # ------------------------------
  constant_ref:
    name: variable.parameter.constant.lookml
    match: \@\{[A-Za-z0-9_]*\}

  dollar_field_ref:
    patterns:
      - name: variable.language.field.lookml
        match: \$\{([A-Za-z0-9_]+\.)?(SQL_TABLE_NAME)\}
        captures:
          2:
            name: support.constant.sql_table_name.lookml
      - name: variable.language.field.lookml
        match: \$\{[A-Za-z0-9_]*(\.[A-Za-z0-9_]*)?\}

  # ------------------------------
  # materialization / cache
  # ------------------------------
  datagroup_trigger:
    match: \b(datagroup_trigger)\s*:\s*([A-Za-z0-9_$@*.-]*)
    captures:
      1:
        name: keyword.control.option_ident.lookml
      2:
        patterns:
          - include: "#ident_no_dot"

  distribution_style:
    match: \b(distribution_style)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.format.lookml
      2:
        patterns:
          - name: support.constant.distribution_style.lookml
            match: \b(all|even)\b
          - name: invalid.illegal.distribution_style.lookml
            match: "[^\\s]+"

  # ------------------------------
  # other
  # ------------------------------
  extension:
    match: \b(extension)\s*:\s*(\w*)
    captures:
      1:
        name: keyword.control.extension.lookml
      2:
        patterns:
          - name: support.constant.day.lookml
            match: \b(required)\b
          - name: invalid.illegal.day.lookml
            match: \w+

  drill_fields:
    begin: \b(drill_fields)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.drill_fields.lookml
    end: \]
    patterns:
      - include: "#comments"
      - include: "#fields_allow_star"


  # ------------------------------
  # single line option
  # ------------------------------
  string:
    name: string.quoted.double.lookml
    begin: \"
    end: \"
    patterns:
      - include: "#liquid_block"
      - include: "#constant_ref"
      - name: constant.character.escape.lookml
        match: \\.

  yesno:
    patterns:
      - name: support.constant.yesno.lookml
        match: \b(yes|no)\b
      - name: invalid.illegal.yesno.lookml
        match: '[A-Za-z0-9_$@*.-]+'

  numeric:
    patterns:
      - name: constant.numeric.lookml
        match: \b(\d+)\b
      - name: invalid.illegal.numeric.lookml
        match: '[A-Za-z0-9_$@*.-]+'

  ident:
    patterns:
      - name: invalid.illegal.ident.lookml
        match: "[$@]\\{[A-Za-z0-9_$@*.-]*\\}"
      # invalid character
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*[$@*-][A-Za-z0-9_$@*.-]*"
      # two or more dots
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*(\\.[A-Za-z0-9_$@*.-]*){2,}"

  ident_no_dot:
    patterns:
      # invalid character
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*[$@*-][A-Za-z0-9_$@*.-]*"
      # has dot
      - name: invalid.illegal.ident.lookml
        match: "[A-Za-z0-9_$@*.-]*(\\.[A-Za-z0-9_$@*.-]*){1,}"

  # ------------------------------
  # multi line option
  # ------------------------------
  sql_block:
    begin: "\\b([A-Za-z0-9_]+)\\s*:"
    beginCaptures:
      1:
        name: keyword.control.sql_option.lookml
    end: (?=;;)
    contentName: meta.embedded.block.sql
    patterns:
      - include: "#liquid_block"
      - include: "#constant_ref"
      - include: "#dollar_field_ref"
      - include: source.sql

  html_block:
    begin: "\\b([A-Za-z0-9_]+)\\s*:"
    beginCaptures:
      1:
        name: keyword.control.html_option.lookml
    end: (?=;;)
    contentName: meta.embedded.block.html
    patterns:
      - include: "#liquid_block"
      - include: "#constant_ref"
      - include: text.html.basic

  liquid_block:
    patterns:
      - name: meta.embedded.block.liquid
        begin: (?=\{\%)
        end: (?<=\%\})
        patterns:
          - include: source.liquid.lookml
      - name: meta.embedded.block.liquid
        begin: (?=\{\{)
        end: (?<=\}\})
        patterns:
          - include: source.liquid.lookml

  option_ident_array:
    begin: \b([A-Za-z0-9_]+)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.option_ident_array.lookml
    end: (?=\])
    patterns:
      - include: "#comments"
      - include: "#ident"
      - include: "#invalid_curl"

  option_ident_no_dot_array:
    begin: \b([A-Za-z0-9_]+)\s*:\s*\[
    beginCaptures:
      1:
        name: keyword.control.option_ident_array.lookml
    end: (?=\])
    patterns:
      - include: "#comments"
      - include: "#ident_no_dot"
      - include: "#invalid_curl"

  # ------------------------------
  # generic context
  # ------------------------------
  comments:
    name: comment.line.hash.lookml
    match: "#.*"

  invalid_curl:
    patterns:
      - name: invalid.illegal.object_reference.lookml
        match: "[$@]\\{[A-Za-z0-9_$@.*-]*\\}"
      - include: "#_undefined_block"

  _undefined_block:
    name: invalid.illegal.curly_block.lookml
    begin: \{
    end: \}
    patterns:
      - include: "#comments"
      - include: "#_undefined_block"
